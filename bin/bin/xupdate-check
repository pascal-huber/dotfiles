#!/bin/sh
# xupdate-check -S | -l | -m | pattern... - Show update-check info for packages
#    -S Sync with the official update-check results
#    -m Show only manually installed packages

: ${XDG_CACHE_HOME:=~/.cache}
: ${XUC_CACHE:=$XDG_CACHE_HOME/xupdate-check}
: ${XUC_REMOTE:='repo-default.voidlinux.org'}

XUC_REMOTE_RSYNC="rsync://${XUC_REMOTE}/voidlinux/void-updates/void-updates"
XUC_REMOTE_HTTPS="https://${XUC_REMOTE}/void-updates/void-updates"

if ! command -v rsync >/dev/null 2>&1; then
	echo "xupdatecheck: rsync command not found." 1>&2
	exit 2
fi

last_modified_remote() {
	line=$(curl -s -v -X HEAD "${XUC_REMOTE_HTTPS}/_log.txt" 2>&1 | grep last-modified)
	if [ "$line" = "" ]; then
		echo "xupdatecheck: could not fetch remote timestamp" 1>&2
	fi
	echo "${line#*:}"
}

check_cache_timestamp() {
	timestamp_remote="$(last_modified_remote)"
	[ "$timestamp_remote" != "" ] || return
	timestamp_cache=$(cat "${XUC_CACHE}/timestamp")
	if ! [ "$timestamp_remote" = "$timestamp_cache" ]; then
		echo "xupdate-check: cache outdated, please run xupdate-check -S." 1>&2
	fi
}

update_cache() {
	timestamp_remote=$(last_modified_remote)
	set -e
	rsync -rPz "${XUC_REMOTE_RSYNC}" "${XUC_CACHE}" --delete >/dev/null 2>&1
	echo "$timestamp_remote" >"${XUC_CACHE}/timestamp"
}

update_check() {
	grep -h "^${pkg} .*->.*" "${XUC_CACHE}"/void-updates/updates_*
	grep "NO VERSION found for ${pkg}$" "${XUC_CACHE}/void-updates/_log.txt"
}

pkgs=""
case "$1" in
"-S")
	update_cache
	exit
	;;
"-m")
	pkgs=$(xbps-query -m | sed 's#\(.*\)-[^-]*#\1#g')
	;;
"-l")
	pkgs=$(xbps-query -l | cut -d" " -f2 | sed 's#\(.*\)-[^-]*#\1#g')
	;;
*)
	pkgs="$*"
	;;
esac

if [ ! -d "${XUC_CACHE}" ]; then
	echo "xupdate-check: cache inexistent, please run xupdate-check -S." 1>&2
	exit 3
fi

check_cache_timestamp
for pkg in $pkgs; do
	update_check "${pkg}"
done
